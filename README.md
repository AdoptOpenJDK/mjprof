mjprof
=======
mjprof is a command line monadic java profiler.

Introduction
=============
mjprof is a monadic thread dump analysis tool set. It is a fancy way to say it analyzes jstack output using a series of simple composable building blocks (monads).

Motivation
==========
So, You are out there in the wild vs a production machine. All you have have in hand is the "poor man's profiler" jstack.
You take one, two, three stack dumps and then you need to look at them manually inside an editor, vi, less, etc....
If you have done it enough times, you probably know that it is a lot of manual work. Especially when you have thousands of threads in your process.

Running mjprof
===========
mjprof reads thread dumps from one or more data sources and writes to the standard output.  An example of a data source can be the standard input. 

The following will filter out all the threads which are not in RUNNABLE state:  
`jstack -l pid | ./mjprof.sh contains/state,RUNNABLE/`

The commands passed to mjprof consists of several building blocks, monads from now on, concatenated with , (comma)
While the monads are relatively simple, mixing and matching them can yield a very thorough 
analysis, while still allowing you to focus on the data you need.
Monad parameters are wrapped with / (instead of () {} or [] which are special chars in the shell) and seperated by ,

Monads 
======

Data Sources
------------
Data sources generate thread dumps and feed them into mjprof. The default data source is stdin. When no data source is specified stdin will be used.
When more than one data source is specified the thread dumps generated by all of them will be fed into mjprof.

* _**jmx**/host:port|MainClass|pid,[count],[sleep],[username],[passwd]/_    - Generate dumps via JMX 
* _**jmxc**/host:port|MainClass|pid,[count],[sleep],[username],[passwd]/_   - Generates thread dumps dumps via JMX and collect sper thread CPU
* _**jstack**/pid|mainClassName,[count],[sleep]/_                           - Generate dumps using jstack
* _**path**/path/_                                                          - Read thread dump from file
* _**stdin**_                                                               - Read thread dumps from standard input
* _**visualvm**/path/_                                                      - Read profiling session from xml export of VisualVM

Output
------
* _**gui**/[title],[maxInvocations]/_                                       - Display current thread dump in a GUI window
* _**snapshot**/[filename]/_                                                - Write to a file
* _**stdout**_                                                              - Writes current stream of thread dumps to stdout

Filters
-------
* _**contains**/attr,value/_                                                - Returns only threads which contain the string in certain attribute (regexp not supported)
* _**-contains**/attr,value/_                                               - Returns only threads which do not contain the string (regexp not supported)

Single thread mappers
---------------------
* _**-at**_                                                                 - Eliminates the 'at' from the beginning of stack frames
* _**bottom**/int/_                                                         - Returns at most n bottom stack frames of the stack
* _**-fn**_                                                                 - Eliminates file name and line from stack frames
* _**frame**/string/_                                                       - Eliminates stack frames from all stacks which do not contain string.
* _**-frame**/string/_                                                      - Eliminates stack frames from all stacks which contain string.
* _**-namesuffix**_                                                         - Trim the last number from thread names helps grouping thread pool threads together
* _**noop**_                                                                - Does nothing
* _**-pkg**_                                                                - Eliminates package name from stack frames
* _**-prop**/attr/_                                                         - Removes a certain attribute e.g. eliminate/stack/
* _**top**/int/_                                                            - Returns at most n top stack frames of the stack
* _**trimbelow**/string/_                                                   - Trim all stack frames below the first occurrence of string

Full dump mappers:
-----------------
* _**group**/[attr]/_                                                       - Group a single thread dump by an attribute. If not attribute is specified all dump is merged
* _**merge**/attribute/_                                                    - Combine all dumps to a single one merge based on thread id attribute
* _**sort**/attr/_                                                          - Sorts based on an attribute
* _**-sort**/string/_                                                       - Sorts based on an attribute (descending order)

Terminals:
---------
* _**count**_                                                               - counts number of threads
* _**ctree**_                                                               - combine all stack traces with colors (UNIX Terminal) 
* _**flat**_                                                                - Shows flat histogram of the profiles
* _**list**_                                                                - lists the possible stack trace attributes
* _**tree**_                                                                - combine all stack traces 

* _**help**_                                  -Prints this message

Macros:
* _**blocked**_                                                             - contains/state,BLOCKED/
* _**jvm**_                                                                 - ncontains/stack,at/
* _**-jvm**_                                                                - contains/stack,at/.ncontains/name,RMI TCP /.ncontains/name,Reference Handle/.ncontains/name,Finalizer/.ncontains/name,JMX server connection timeout/.ncontains/name,RMI Scheduler/
* _**locks**_                                                               - stackkeep/- /
* _**-locks**_                                                              - stackelim/- /
* _**parking**_                                                             - contains/state,TIMED_WAITING/.contains/stack,sun.misc.Unsafe.park/
* _**running**_                                                             - contains/state,RUNNABLE/
* _**sleeping**_                                                            - contains/state,TIMED_WAITING/
* _**waiting**_                                                             - contains/state,WAITING/
* _**withstack**_                                                           - contains/stack,at/

Properties
----------
Properties may change from one dump to another and the can also be eliminated by **mjstack**.
Following is the list of usual properties  
* _**status**_          - The status of the thread
* _**nid**_             - Native thread id ( a number)
* _**name**_            - Name of thread
* _**state**_           - State of thread
* _**los**_             - The locked ownable synchronizers part of the stack trace
* _**daemon**_          - Whether the thread is a daemon or not
* _**tid**_             - The thread id (a number)
* _**prio**_            - Thread priority, a number
* _**stack**_           - The actual stack trace
* _**cpu_ns**_          - cpu consumed in nano seconds
* _**wall_ms**_         - wall time in ms for the time frame cpu was recorded 
* _**%cpu**_            - %cpu of the thread info

You can also get the actual list of properties bu using the list monad.  
`jstack -l pid | ./mjprof list`

Examples
=============
jstack Original output:  
`jstack -l 38515 > mystack.txt`  
Keep only thread which their names contain ISCREAM:  
`jstack -l 38515  | mjprof contains/name,ISCREAM/`  
Sort them by state  
`cat mystack.txt  | mjprof contains/name,ISCREAM/.sort/state/`  
Eliminate the Locked Ownable Synchronizers Section  
`jstack -l 38515  | mjprof contains/name,ISCREAM/.sort/state/.eliminate/los/`  
Shorten stack traces to include only 10 last stack frames  
`mjprof jstack/MyAppMainClass/.contains/name,ISCREAM/.sort/state/.eliminate/los/.keeptop/10/`  
Count threads  
`mjprof jstack/38515/.contains/name,ISCREAM/.sort/state/.eliminate/los/.keeptop/10/.count`



Building MJProf
=============
mjprof uses maven for compilation. In order to build mjprof use the following command line:  
`mvn clean package`
This will create a zip file in `target/mjprof1.0-bin.zip` which contains everything you need.


Writing a plugin
===============

mjprof monadic capabilities can be extended with plugins. If you feel something is missing you can write your own plugin. 
We will appreciate if you will contribute it back to the community. 
A plugin is a Java class which is annotated with the com.performizeit.mjprof.plugin.Plugin. The annotation accepts three parameters. "name" the
plugin name (must be unique) paramTypes the expected parameter types in the plugin. description one liner that will be used for 
synopsis. For example:  

```
import com.performizeit.mjprof.api.Plugin;

@Plugin(name="group", paramTypes={String.class},description="Group by an attribute")
```
There are several plugin types mappers filters terminals etc... for each type you will  need to implement a different interface.

Mapper
------
Implement JStackMapper interface which includes a single method 
`ThreadInfo map(ThreadInfo stck)`

Filter
------
Implement JStackFilter interface which includes a single method 
`boolean filter(ThreadIndo stck)`

Terminal
------
Implement JStackFilter interface which includes a single method 
`void addStackDump(JStackDump jsd)` 

Comparator
------
Implement JStackComparator interface which includes a single method 
`int compare(ThreadInfo o1, ThreadInfo o2)`



Installing a plugin
============
In order to install the plugin just drop your jar which contains plugin implementation  into the 'plugins' directory 
inside mjprof installation directory.
